<% layout('layouts/boilerplate') -%>

<div class="row">

  <div class="col-lg-3">
    <h3>Filter By:</h3>
    <form action="/posts" method="GET" id="post-filter-form">
    	<div class="form-group">
	    	<label for="search">Search</label>
	    	<input type="text" class="form-control" id="search" name="post[search]" placeholder="Search">
	    </div>
    	<fieldset>
    		<legend id="condition-legend">Condition</legend>
    		<div class="form-check form-check-inline">
    		  <label class="form-check-label">
    		    <input class="form-check-input" type="checkbox" value="excellent" name="post[condition]"> Excellent
    		  </label>
    		</div>
    		<div class="form-check form-check-inline">
    		  <label class="form-check-label">
    		    <input class="form-check-input" type="checkbox" value="good" name="post[condition]"> Good
    		  </label>
    		</div>
    		<div class="form-check form-check-inline">
    		  <label class="form-check-label">
    		    <input class="form-check-input" type="checkbox" value="poor" name="post[condition]"> Poor
    		  </label>
    		</div>
    	</fieldset>
    	<div class="form-group">
	    	<label for="price">Price</label>
	    	<input type="number" class="form-control" id="price" name="post[price]" min="0" step="1" placeholder="Price">
	    </div>
    	<div class="form-group">
	    	<label for="location">Location</label>
	    	<input type="text" class="form-control" id="location" name="post[location]" placeholder="Address or Zipcode">
	    </div>
    	<div class="form-group">
	    	<label for="distance">Distance</label>
	    	<input type="number" class="form-control" id="distance" name="post[distance]" min="0" step="1" max="600" placeholder="Distance">
	    </div>

    	<input type="submit" class="btn btn-primary btn-block" role="button" value="Go!">
    </form>

  </div> 
  <!-- /.col-lg-3 -->
	
	<div class="col-lg-9">

<!-- 		<button id="user-location" class="btn btn-default mb-3 float-sm-right float-xs-left"><i class="fa fa-crosshairs" aria-hidden="true"></i> Use My Location</button>
		<form class="form-inline" id="address-form">
		  <div class="form-group mb-3">
		    <label for="address" class="sr-only">Zip Code/Address</label>
		    <input type="text" name="address" class="form-control" id="address" placeholder="Zip Code/Address">
		  </div>
		  <button type="submit" class="btn btn-primary mb-3 ml-1">Search</button>
		</form> -->

		<div id="map" class="mb-4 rounded"></div>

		<div class="row" id="posts-row">
			<% posts.forEach((post) => { %>
			<div class="col-lg-4 col-md-6 mb-4">
			  <div class="card h-100">
			    <a href="/posts/<%= post.id %>"><img class="card-img-top" src="<%= post.image %>" alt="<%= post.title %>"></a>
			    <div class="card-body">
			      <h4 class="card-title">
			        <a href="/posts/<%= post.id %>"><%= post.title %></a>
			      </h4>
			      <h5>$<%= post.price %>.00</h5>
			      <p class="card-text"><%- post.description.substring(0, 20) %><%= post.description.length > 20 ? '...' : '' %></p>
			      <a href="/posts/<%= post.id %>" class="btn btn-primary">View Board</a>
			    </div>
			    <div class="card-footer">
			      <small class="text-muted"><%= post.condition %></small>
			    </div>
			  </div>
			</div>
			<% }); %>
		</div>
		<% if (paginate.hasPreviousPages || paginate.hasNextPages(pageCount)) { %>
		<div class="row justify-content-center">
			<div class="col-4">		
				<nav aria-label="Page navigation">
					<ul class="pagination justify-content-center">
						<% if (paginate.hasPreviousPages) { %>
						<li class="page-item">
							<a href="<%= paginate.href(true) %>" class="page-link" aria-label="Previous">
								<span aria-hidden="true">&laquo;</span>
							</a>
						</li>
						<% } %>
						<% if (pages) { %>
						<% pages.forEach(function(page) { %>
						<li class="page-item <% if(page.number === pageNumber) { %>active<% } %>"><a href="<%= page.url %>" class="page-link"><%= page.number %></a></li>
						<% }); %>
						<% } %>
						<% if (paginate.hasNextPages(pageCount)) { %>
						<li class="page-item">
							<a href="<%= paginate.href() %>" class="page-link" aria-label="Next">
								<span aria-hidden="true">&raquo;</span>
							</a>
						</li>
						<% } %>
					</ul>
				</nav>
			</div>
			<!-- /.col-3 -->
		</div>
		<!-- /.row -->
		<% } %>
  </div>
  <!-- /.col-lg-9 -->

</div>
<!-- /.row -->

<script>
	var map, infoWindow, geocoder, loadMarkers;
	var posts = <%- JSON.stringify(posts) %>

	function initMap() {
		geocoder = new google.maps.Geocoder();
		map = new google.maps.Map(document.getElementById('map'), {
			zoom: 10,
			center: new google.maps.LatLng(37.773972, -122.431297),
			mapTypeId: 'terrain'
		});

		loadMarkers = function(posts) {
			var markers = [];
			var bounds = new google.maps.LatLngBounds();

			for (var i = 0; i < posts.length; i++) {
			  var latLng = new google.maps.LatLng(posts[i].coordinates[1], posts[i].coordinates[0]);
			  var marker = new google.maps.Marker({
	        position: latLng,
	        label: posts[i].title,
	        url: '/posts/' + posts[i]._id
	      });
	      google.maps.event.addListener(marker, 'click', function() {
	          window.location.href = this.url;
	      });
			  markers.push(marker);
			  bounds.extend(markers[i].getPosition());
			}

			map.fitBounds(bounds);

			var markerCluster = new MarkerClusterer(map, markers,
	            {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
		}

		loadMarkers(posts);
		// Get user location
		getLocation();

		function getLocation() {
			infoWindow = new google.maps.InfoWindow;
	    // Try HTML5 geolocation.
			// Note: This example requires that you consent to location sharing when
			// prompted by your browser. If you see the error "The Geolocation service
			// failed.", it means you probably did not give permission for the browser to
			// locate you.
	    if (navigator.geolocation) {
	      navigator.geolocation.getCurrentPosition(function(position) {
	        var pos = {
	          lat: position.coords.latitude,
	          lng: position.coords.longitude
	        };

	        infoWindow.setPosition(pos);
	        infoWindow.setContent('You are here.');
	        infoWindow.open(map);

	        map.setCenter(pos);
	        map.setZoom(10);

      		// Update DOM with posts near user location
      		$.get(`/posts?post%5Blongitude%5D=${pos.lng}&post%5Blatitude%5D=${pos.lat}`)
      		  .done(paintDom)
        		.fail(handleError);

	      }, function() {
	        handleLocationError(true, infoWindow, map.getCenter());
	      });
	    } else {
	      // Browser doesn't support Geolocation
	      handleLocationError(false, infoWindow, map.getCenter());
	    }
		}

		function handleLocationError(browserHasGeolocation, infoWindow, pos) {
		  infoWindow.setPosition(pos);
		  infoWindow.setContent(browserHasGeolocation ?
		                        'Error: The Geolocation service failed.' :
		                        'Error: Your browser doesn\'t support geolocation.');
		  infoWindow.open(map);
		}

		function paintDom(data) {
			// clear currently loaded posts
			$('#posts-row').html('');
			// loop over posts and append each to DOM
			data.posts.forEach(function(post) {
				$('#posts-row').append(`
					<div class="col-lg-4 col-md-6 mb-4">
					  <div class="card h-100">
					    <a href="/posts/${ post._id }"><img class="card-img-top" src="${ post.image }" alt="${ post.title }"></a>
					    <div class="card-body">
					      <h4 class="card-title">
					        <a href="/posts/${ post._id }">${ post.title }</a>
					      </h4>
					      <h5>$${ post.price }.00</h5>
					      <p class="card-text">${ post.description.substring(0, 20) }${ post.description.length > 20 ? '...' : '' }</p>
					      <a href="/posts/${ post._id }" class="btn btn-primary">View Board</a>
					    </div>
					    <div class="card-footer">
					      <small class="text-muted">${ post.condition }</small>
					    </div>
					  </div>
					</div>
				`)
			});
			// clear the current page numbers
			$('ul.pagination').html('');
			// build html string template
			var paginateTemplate = ``;
			// check if has_previous pages and add prev button
			if (data.has_prev) {
				// remove erroneous &page= from data.prevUrl
				data.prevUrl = data.prevUrl.replace('post=', '');
				paginateTemplate += `
				<li class="page-item">
					<a href="${ data.prevUrl }" class="page-link" aria-label="Previous">
						<span aria-hidden="true">&laquo;</span>
					</a>
				</li>
				`
			}
			// check is there are multiple pages and add page number buttons
			if (data.pages.length > 1) {
				data.pages.forEach(function(page) {
					// remove erroneous &page= from page.url
					page.url = page.url.replace('post=', '');
					paginateTemplate += `<li class="page-item ${ page.number === data.pageNumber ? 'active' : '' }"><a href="${ page.url }" class="page-link">${ page.number }</a></li>`;
				});
			}
			// check if has_next pages
			if (data.has_next) {
				// remove erroneous &page= from data.nextUrl
				data.nextUrl = data.nextUrl.replace('post=', '');
				// add next button to page numbers
				paginateTemplate += `
					<li class="page-item">
						<a href="${ data.nextUrl }" class="page-link" aria-label="Next">
							<span aria-hidden="true">&raquo;</span>
						</a>
					</li>
					`
			}
			// if paginate buttons exist then add them to the DOM
			if (paginateTemplate) $('ul.pagination').html(paginateTemplate);
			// if posts exist then update map with visible posts
			if(data.posts.length) {
				// load post markers to map
				loadMarkers(data.posts);
			}
		};

		// handle failed AJAX requests
		function handleError(jqXHR, exception) {
			alert(exception);
		};

	}

</script>

<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBkG51lwJtDvYFKTBdRZlhzYg1D4QFsXPU&callback=initMap"></script>
