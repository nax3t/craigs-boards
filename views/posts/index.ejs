<% layout('layouts/boilerplate') -%>

<div class="row">

  <div class="col-lg-3">
  	<a href="/posts/new" class="mb-2 btn btn-primary"><i class="fa fa-plus" aria-hidden="true"></i> New Post</a>

    <h1 class="my-4">Filter Results</h1>
    <form action="/posts" method="GET">
    	<div class="form-group">
	    	<label for="search">Search</label>
	    	<input type="text" class="form-control" id="search" name="post[search]" placeholder="Search">
	    </div>
    	<fieldset>
    		<legend id="condition-legend">Condition</legend>
    		<div class="form-check form-check-inline">
    		  <label class="form-check-label">
    		    <input class="form-check-input" type="checkbox" value="excellent" name="post[condition]"> Excellent
    		  </label>
    		</div>
    		<div class="form-check form-check-inline">
    		  <label class="form-check-label">
    		    <input class="form-check-input" type="checkbox" value="good" name="post[condition]"> Good
    		  </label>
    		</div>
    		<div class="form-check form-check-inline">
    		  <label class="form-check-label">
    		    <input class="form-check-input" type="checkbox" value="poor" name="post[condition]"> Poor
    		  </label>
    		</div>
    	</fieldset>
    	<div class="form-group">
	    	<label for="price">Price</label>
	    	<input type="number" class="form-control" id="price" name="post[price]" min="0" step="1" placeholder="Price">
	    </div>
    	<div class="form-group">
	    	<label for="address">Address</label>
	    	<input type="text" class="form-control" id="address" name="post[location]" placeholder="Address">
	    </div>

    	<input type="submit" class="btn btn-success" role="button" value="Go!">
    </form>

  </div>
  <!-- /.col-lg-3 -->
	
	<div class="col-lg-9">

		<button id="user-location" class="btn btn-default mb-3 float-sm-right float-xs-left"><i class="fa fa-crosshairs" aria-hidden="true"></i> Use My Location</button>
		<form class="form-inline" id="address-form">
		  <div class="form-group mb-3">
		    <label for="address" class="sr-only">Zip Code/Address</label>
		    <input type="text" name="address" class="form-control" id="address" placeholder="Zip Code/Address">
		  </div>
		  <button type="submit" class="btn btn-primary mb-3 ml-1">Search</button>
		</form>

		<div id="map" class="mb-4 rounded"></div>

		<div class="row">
			<% posts.forEach((post) => { %>
			<div class="col-lg-4 col-md-6 mb-4">
			  <div class="card h-100">
			    <a href="/posts/<%= post.id %>"><img class="card-img-top" src="<%= post.image %>" alt="<%= post.title %>"></a>
			    <div class="card-body">
			      <h4 class="card-title">
			        <a href="/posts/<%= post.id %>"><%= post.title %></a>
			      </h4>
			      <h5>$<%= post.price %>.00</h5>
			      <p class="card-text"><%- post.description.substring(0, 20) %><%= post.description.length > 20 ? '...' : '' %></p>
			      <a href="/posts/<%= post.id %>" class="btn btn-primary">View Board</a>
			    </div>
			    <div class="card-footer">
			      <small class="text-muted"><%= post.condition %></small>
			    </div>
			  </div>
			</div>
			<% }); %>
		</div>
		
		<div class="row justify-content-center">
			<div class="col-3">		
				<nav>
					<ul class="pagination">
						<li class="page-item">
							<a href="#" class="page-link" aria-label="Previous">
								<span aria-hidden="true">&laquo;</span>
							</a>
						</li>
						<li class="page-item"><a href="#" class="page-link">1</a></li>
						<li class="page-item"><a href="#" class="page-link">2</a></li>
						<li class="page-item"><a href="#" class="page-link">3</a></li>
						<li class="page-item"><a href="#" class="page-link">4</a></li>
						<li class="page-item">
							<a href="#" class="page-link" aria-label="Next">
								<span aria-hidden="true">&raquo;</span>
							</a>
						</li>
					</ul>
				</nav>
			</div>
			<!-- /.col-md-6 -->
		</div>
		<!-- /.row -->

  </div>
  <!-- /.col-lg-9 -->

</div>
<!-- /.row -->

<script>
	var map, infoWindow;
	var posts = <%- JSON.stringify(posts) %>

	function initMap() {
		map = new google.maps.Map(document.getElementById('map'), {
			zoom: 10,
			center: new google.maps.LatLng(37.773972, -122.431297),
			mapTypeId: 'terrain'
		});

		var markers = [];
		var bounds = new google.maps.LatLngBounds();

		for (var i = 0; i < posts.length; i++) {
		  var latLng = new google.maps.LatLng(posts[i].lat, posts[i].lng);
		  var marker = new google.maps.Marker({
        position: latLng,
        label: posts[i].title,
        url: '/posts/' + posts[i]._id
      });
      google.maps.event.addListener(marker, 'click', function() {
          window.location.href = this.url;
      });
		  markers.push(marker);
		  bounds.extend(markers[i].getPosition());
		}

		map.fitBounds(bounds);

		var markerCluster = new MarkerClusterer(map, markers,
            {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});

		// Get user location
		var getUserLocationBtn = document.getElementById('user-location')

		getUserLocationBtn.addEventListener('click', getLocation);

		infoWindow = new google.maps.InfoWindow;

		function getLocation() {
	    // Try HTML5 geolocation.
			// Note: This example requires that you consent to location sharing when
			// prompted by your browser. If you see the error "The Geolocation service
			// failed.", it means you probably did not give permission for the browser to
			// locate you.
	    if (navigator.geolocation) {
	      navigator.geolocation.getCurrentPosition(function(position) {
	        var pos = {
	          lat: position.coords.latitude,
	          lng: position.coords.longitude
	        };

	        infoWindow.setPosition(pos);
	        infoWindow.setContent('You are here.');
	        infoWindow.open(map);

	        map.setCenter(pos);
	        map.setZoom(10);
	      }, function() {
	        handleLocationError(true, infoWindow, map.getCenter());
	      });
	    } else {
	      // Browser doesn't support Geolocation
	      handleLocationError(false, infoWindow, map.getCenter());
	    }
		}

		function handleLocationError(browserHasGeolocation, infoWindow, pos) {
		  infoWindow.setPosition(pos);
		  infoWindow.setContent(browserHasGeolocation ?
		                        'Error: The Geolocation service failed.' :
		                        'Error: Your browser doesn\'t support geolocation.');
		  infoWindow.open(map);
		}

	}

</script>

<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBkG51lwJtDvYFKTBdRZlhzYg1D4QFsXPU&callback=initMap"></script>
